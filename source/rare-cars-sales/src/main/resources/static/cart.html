<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cart - Revline</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<header style="background-color: #D80000;">
    <div style="display: flex; align-items: center; gap: 20px;">
        <div class="logo">REV<span style="color: black;">LINE</span></div>
        <a href="index.html" class="btn" style="background: #D80000; color: white; border: 2px solid white;">Shop</a>
    </div>
    <a href="cart.html">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/shopping-cart.png" width="30" height="30">
    </a>
</header>

<div id="cartSection" style="max-width: 800px; margin: 30px auto; padding: 0 20px;">
    <div style="background: #1a1a1a; border-radius: 10px; padding: 25px;">
        <h2 style="color: white; font-weight: normal; margin-bottom: 20px;">Checkout</h2>

        <div id="cartItems" style="background: white; border-radius: 8px;">
            <p style="padding: 20px;">Loading cart...</p>
        </div>

        <div style="text-align: right; margin-top: 20px;">
            <div id="subtotalBox" style="display: inline-block; background: white; padding: 12px 20px; border: 2px solid black; font-size: 20px;">
                Subtotal: <span id="cartSubtotal">$0.00</span>
            </div>
        </div>

        <div id="payNowDiv" style="text-align: right; margin-top: 15px; display: none;">
            <button class="btn btn-red" onclick="showPayment()" style="padding: 12px 35px; font-size: 16px;">Pay now</button>
        </div>
    </div>
</div>

<div id="paymentSection" style="max-width: 800px; margin: 30px auto; padding: 0 20px; display: none;">
    <div style="background: #1a1a1a; border-radius: 10px; padding: 25px;">
        <h2 style="color: white; font-weight: normal; margin-bottom: 20px;">Payment Details</h2>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1; background: white; padding: 20px; border-radius: 8px;">
                <h4 style="margin-top: 0;">Shipping Address</h4>
                <input type="text" id="street" placeholder="Street Address">
                <input type="text" id="city" placeholder="City">
                <input type="text" id="state" placeholder="State">
                <input type="text" id="zip" placeholder="Zip Code">
                <input type="text" id="phone" placeholder="Phone Number">

                <label style="display: block; margin-top: 10px;">Shipping Speed:</label>
                <select id="shippingSpeed" onchange="updateTotals()">
                    <option value="Ground">Ground (Free)</option>
                    <option value="3-Day">3-Day ($19.00)</option>
                    <option value="Overnight">Overnight ($29.00)</option>
                </select>
            </div>

            <div style="flex: 1; background: white; padding: 20px; border-radius: 8px;">
                <h4 style="margin-top: 0;">Payment Method</h4>
                <input type="text" placeholder="Credit Card Number">
                <div style="display: flex; gap: 10px;">
                    <input type="text" placeholder="MM/YY" style="flex: 1;">
                    <input type="text" placeholder="CVV" style="flex: 1;">
                </div>
                <p style="font-size: 12px; color: #666;">* We only save the last 4 digits.</p>
                <input type="text" id="cardLast4" placeholder="Last 4 Digits (Required)">
            </div>
        </div>

        <div style="text-align: right; margin-top: 20px;">
            <button class="btn btn-red" onclick="showSummary()" style="padding: 12px 35px; font-size: 16px;">Continue</button>
        </div>
    </div>
</div>

<div id="summarySection" style="max-width: 800px; margin: 30px auto; padding: 0 20px; display: none;">
    <div style="background: #1a1a1a; border-radius: 10px; padding: 25px;">
        <h2 style="color: white; font-weight: normal; margin-bottom: 20px;">Order Summary</h2>

        <div id="summaryItems" style="background: white; border-radius: 8px;">
        </div>

        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <div style="flex: 1; background: #e8f5e9; padding: 12px 15px; border: 2px solid black; text-align: center; font-size: 18px;">
                Subtotal: <span id="finalSub">$0.00</span>
            </div>
            <div style="flex: 1; background: #e8f5e9; padding: 12px 15px; border: 2px solid black; text-align: center; font-size: 18px;">
                Tax: <span id="finalTax">$0.00</span>
            </div>
            <div style="flex: 1; background: #e8f5e9; padding: 12px 15px; border: 2px solid black; text-align: center; font-size: 18px;">
                Shipping: <span id="finalShip">$0.00</span>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
            <div style="background: #e8f5e9; padding: 12px 25px; border: 2px solid black; font-size: 20px; font-weight: bold;">
                Total: <span id="finalTotal">$0.00</span>
            </div>
            <button class="btn btn-red" onclick="submitOrder()" style="padding: 12px 25px; font-size: 16px;">Complete Order</button>
        </div>
    </div>
</div>

<script>
    var cartTotal = 0;
    var cartItems = [];

    window.onload = function() {
        loadCart();
    };

    async function loadCart() {
        var response = await fetch('/api/cart');
        cartItems = await response.json();

        var container = document.getElementById('cartItems');
        container.innerHTML = '';
        cartTotal = 0;

        if (cartItems.length === 0) {
            container.innerHTML = '<p style="padding: 30px; text-align: center; color: #666;">Your cart is empty.</p>';
            document.getElementById('payNowDiv').style.display = 'none';
            return;
        }

        for (var i = 0; i < cartItems.length; i++) {
            var car = cartItems[i];
            cartTotal = cartTotal + car.price;

            var itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee;';

            itemDiv.innerHTML =
                '<button onclick="removeItem(' + car.carID + ')" style="background: none; border: none; cursor: pointer; margin-right: 15px;">' +
                '<img src="https://img.icons8.com/ios-filled/50/D80000/trash.png" width="24" height="24">' +
                '</button>' +
                '<span style="flex: 1; font-size: 16px;">' + car.year + ' ' + car.make + ' ' + car.model + '</span>' +
                '<img src="' + car.imagePath + '" style="width: 100px; height: 60px; object-fit: cover; border-radius: 5px; margin: 0 20px;">' +
                '<span style="font-size: 16px; font-weight: bold; min-width: 100px; text-align: right;">$' + car.price.toLocaleString(undefined, {minimumFractionDigits: 2}) + '</span>';

            container.appendChild(itemDiv);
        }

        document.getElementById('cartSubtotal').innerText = '$' + cartTotal.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('payNowDiv').style.display = 'block';
        updateTotals();
    }

    async function removeItem(carId) {
        await fetch('/api/cart/remove/' + carId, { method: 'POST' });
        loadCart();
    }

    function showPayment() {
        document.getElementById('cartSection').style.display = 'none';
        document.getElementById('paymentSection').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function showSummary() {
        var street = document.getElementById('street').value;
        var card = document.getElementById('cardLast4').value;

        if (street === '' || card === '') {
            alert('Please fill in shipping address and card info.');
            return;
        }

        var summaryDiv = document.getElementById('summaryItems');
        summaryDiv.innerHTML = '';

        for (var i = 0; i < cartItems.length; i++) {
            var car = cartItems[i];

            var itemDiv = document.createElement('div');
            itemDiv.style.cssText = 'display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee;';

            itemDiv.innerHTML =
                '<span style="flex: 1; font-size: 16px;">' + car.year + ' ' + car.make + ' ' + car.model + '</span>' +
                '<img src="' + car.imagePath + '" style="width: 100px; height: 60px; object-fit: cover; border-radius: 5px; margin: 0 20px;">' +
                '<span style="font-size: 16px; font-weight: bold; min-width: 100px; text-align: right;">$' + car.price.toLocaleString(undefined, {minimumFractionDigits: 2}) + '</span>';

            summaryDiv.appendChild(itemDiv);
        }

        document.getElementById('paymentSection').style.display = 'none';
        document.getElementById('summarySection').style.display = 'block';
        window.scrollTo(0, 0);
    }

    function updateTotals() {
        var speed = document.getElementById('shippingSpeed').value;
        var shipping = 0;

        if (speed === 'Overnight') {
            shipping = 29;
        } else if (speed === '3-Day') {
            shipping = 19;
        }

        var tax = cartTotal * 0.06;
        var total = cartTotal + tax + shipping;

        document.getElementById('finalSub').innerText = '$' + cartTotal.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('finalTax').innerText = '$' + tax.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('finalShip').innerText = '$' + shipping.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('finalTotal').innerText = '$' + total.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    async function submitOrder() {
        var orderData = {
            street: document.getElementById('street').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zip: document.getElementById('zip').value,
            phone: document.getElementById('phone').value,
            cardLastFour: document.getElementById('cardLast4').value,
            shippingSpeed: document.getElementById('shippingSpeed').value
        };

        var response = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });

        if (response.ok) {
            var receipt = await response.json();
            alert('Order Success! Order ID: ' + receipt.orderID + '\nCheck your email for the receipt.');
            window.location.href = 'index.html';
        } else {
            var errorMsg = await response.text();
            alert('Order Failed: ' + errorMsg);
        }
    }
</script>
</body>
</html>